# Star Schema Benchmark (SSB) for SystemDS [SystemDS-3862](https://issues.apache.org/jira/browse/SYSTEMDS-3862) 


## Foundation
- There are [13 queries already written in SQL](https://github.com/apache/doris/tree/master/tools/ssb-tools/ssb-queries).
- There are existing DML relational algebra operations raSelect(), raJoin() and raGroupBy().
- Our task is to implement the DML version of these queries and run them in SystemDS and PostgreSQL. Therefore, we provide a shell scripts.
- There are existing DML query implementations ([Git request](https://github.com/apache/systemds/pull/2280) and [code](https://github.com/apache/systemds/tree/main/scripts/staging/ssb)) of the previous group which are a bit slow and contain errors. They also provided longer scripts to run experiments in SystemDS, PostgreSQL and DuckDB.

## Directory structure
```
ssb/
├── docker-compose.yaml             # Compose file for Docker containers (here for PostgreSQL)
├── Dockerfile
├── README.md                        # This explanation
├── queries/                         # DML queries (q1_1.dml ... q4_3.dml)
│   ├── q1_1.dml - q1_3.dml          # Flight 1
│   ├── q2_1.dml - q2_3.dml          # Flight 2
│   ├── q3_1.dml - q3_4.dml          # Flight 3
│   └── q4_1.dml - q4_3.dml          # Flight 4
├── shell/
│   ├── run_script.sh                # Main script
└── sql/                             # SQL versions + `ssb.duckdb` for DuckDB
├── other_docker_compose             # Other alternative compose file
```
## Setup
- First, install [Docker](https://docs.docker.com/get-started/get-docker/), [Docker Compose](https://docs.docker.com/compose/install/) and its necessary libraries.
  
  For Ubuntu, there is the following tutorials [for Docker](https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository) and [Docker Compose](https://docs.docker.com/compose/install/linux/#install-using-the-repository) using apt repository. You can add [Docker Desktop](https://docs.docker.com/desktop/setup/install/linux/ubuntu/), too.
  
The shell script covers the installation of the following points. We use Ubuntu and Debian. For other OS, please look closer at the documentations.

- Docker version of the database system [SystemDS](https://apache.github.io/systemds/site/docker)
- Docker compose version of [PostgreSQL](docker-compose.yaml) based on its [documentation]((https://hub.docker.com/_/postgres)).
- [ssb-dbgen](https://github.com/eyalroz/ssb-dbgen/tree/master) (SSB data set generator `datagen`)

For more options look into the original documentation. 

## Structure of the test system
![diagram](other/dia_ssb_script_structure1.jpg)
Our script will depict the following structure.
The data is generated by datagen and stored locally (on localhost). 

After that, it is copied into the database containers (SystemDS, PostgreSQL and DuckDB) where the queries are executed.

 `TODO`: DuckDB locally? Change the diagram.

## Run the script
### Before running the script
Before running the script, create an .env file to set PostgreSQL environment variables.
```
# in .env file
POSTGRES_USER=[YOUR_USERNAME]
POSTGRES_PASSWORD=[YOUR_USERNAME]
POSTGRES_DB=[YOUR_DB_NAME]
PORT_NUMBER=[YOUR_PORT_NUMBER]
```

Mark the script as executable.
```
$ chmod +x run_script.sh
```
### Run the script
To run the queries, we can execute the following shell script `run_script.sh`  (in ssb directory). It has the three following parameter flags.
1. `q`: (QUERY_NAME) Name of the query to be executed.
    - **all**: executes all queries
    - **[QUERY_NAME]** like q1_1 or q1.1: Executes the selected query like q1_1. dml. Both formats q1_1 or q1.1 are allowed. It will be automatically translated.
    - Currently the following queries are avalaible {"q1_1", "q1_2", "q1_3", "q2_1", "q2_2", "q2_3", "q3_1", "q3_2","q3_3", "q3_4", "q4_1", "q4_2", "q4_3"}
2. `s`: (SCALE) The numerical scale factor like 0.01 or 1 etc.
    - Be careful: Please do not experiment with large scale factor over 0.2 in SystemDS. Its join operation is currently very slow.
3. `d`: (DB_SYSTEM) Name of the database system used.
    - **all**: executes all queries
    - **systemds**: SystemDS executes DML scripts.
    - **postgres**: PostgreSQL executes SQL queries.
    - ( **duckdb**: DuckDB executes SQL queries.) 
  
The command line could look like this:
```
$ ./run_script.sh -q [YOUR_QUERY_NAME] -s [YOUR_SCALE] -d [YOUR_DB_SYSTEM]
```
Examples
```
$ ./run_script.sh -q all -s 0.1 -d all
$ ./run_script.sh -q q4_3 -s 0.1 -d systemds
$ ./run_script.sh -q all -s 1 -d postgres
```
If an option is not specified by user, the default values are as follows:
```
QUERY_NAME="q2_1"
SCALE=0.1
DB_SYSTEM="systemds"
```

### Further considerations.
To compare the correctness and do benchmarks, PostgreSQL can be used.