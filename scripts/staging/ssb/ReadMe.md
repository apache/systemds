# Star Schema Benchmark (SSB) for SystemDS [SystemDS-3862](https://issues.apache.org/jira/browse/SYSTEMDS-3862) 


## Foundation
- There are [13 queries already written in SQL](https://github.com/apache/doris/tree/master/tools/ssb-tools/ssb-queries).
- There are existing DML relational algebra operations raSelect(), raJoin() and raGroupBy().
- Our task is to implement the DML version of these queries and run them in SystemDS and PostgreSQL.
- There are existing DML query implementations ([Git request](https://github.com/apache/systemds/pull/2280) and [code](https://github.com/apache/systemds/tree/main/scripts/staging/ssb)) of the previous group which are a bit slow and contain errors. They also provided longer scripts to run experiments in SystemDS, PostgreSQL and DuckDB.
## Changes
1. **DML Queries**
- In this project, we improved and fixed errors of some DML queries.
- The major changes are 
  - Switching the join algorithm from `sort-merge` to `hash2`.
  - Using consistently transformencode() and transformdecode() for string comparisions (Before, it was only used in [q4_3](https://github.com/apache/systemds/tree/main/scripts/staging/ssb/queries/q4_3.dml)). It leads to correct results.
2. **Test Script**
- The main purpose of this project test script is to simply run the queries. The focus is less on benchmarking the execution times. The reason is that the queries run very slow in SystemDS which cannot be compared to PostgreSQL and DuckDB. The main bottleneck are the join algorithms.
- Thus the main differences to the last group are:
  - Using the simpler [ssb-dbgen](https://github.com/eyalroz/ssb-dbgen/tree/master) for generating data.
  - Not a full testbench with detailed views for different execution times and database.
  - Running PostgreSQL and SystemDS in Docker containers instead of using it locally. See below.
## Directory structure
```
ssb/
├── docker-compose.yaml             # Compose file for Docker containers (here for PostgreSQL)
├── Dockerfile
├── README.md                        # This explanation
├── queries/                         # DML queries (q1_1.dml ... q4_3.dml)
│   ├── q1_1.dml - q1_3.dml          
│   ├── q2_1.dml - q2_3.dml          
│   ├── q3_1.dml - q3_4.dml          
│   └── q4_1.dml - q4_3.dml          
├── shell/
│   ├── run_script.sh                # Main script
└── sql/                             # SQL versions & `test_ssb.duckdb` for DuckDB
```
## Setup
- First, install [Docker](https://docs.docker.com/get-started/get-docker/), [Docker Compose](https://docs.docker.com/compose/install/) and its necessary libraries.
  
  For Ubuntu, there is the following tutorials [for Docker](https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository) and [Docker Compose](https://docs.docker.com/compose/install/linux/#install-using-the-repository) using apt repository. You can add [Docker Desktop](https://docs.docker.com/desktop/setup/install/linux/ubuntu/), too.
  
The shell script covers the installation of the following points. We use Ubuntu and Debian. For other OS, please look closer at the documentations.

- Docker version of the database system [SystemDS](https://apache.github.io/systemds/site/docker)
- Docker compose version of [PostgreSQL](docker-compose.yaml) based on its [documentation]((https://hub.docker.com/_/postgres)).
- [ssb-dbgen](https://github.com/eyalroz/ssb-dbgen/tree/master) (SSB data set generator `datagen`)

For more options look into the original documentation. 

## Structure of the test system
![diagram](other/dia_ssb_script_structure1.jpg)
Our script will depict the following structure.
The data is generated by datagen and stored locally (on localhost). 

After that, it is copied into two database containers (SystemDS, PostgreSQL) and a  local DuckDB database where the queries are executed.

## Run the script
### Before running the script
Before running the script, create an .env file to set PostgreSQL environment variables.
```
# in .env file
POSTGRES_USER=[YOUR_USERNAME]
POSTGRES_PASSWORD=[YOUR_USERNAME]
POSTGRES_DB=[YOUR_DB_NAME]
PORT_NUMBER=[YOUR_PORT_NUMBER]
```

Mark the script as executable.
```
$ chmod +x run_script.sh
```
### Run the script
To run the queries, we can execute the following shell script `run_script.sh`  (in ssb directory). It has the three following parameter flags.
1. `-q`: (QUERY_NAME) Name of the query to be executed.
    - `all`: executes all queries
    - **[QUERY_NAME]** like q1_1 or q1.1: Executes the selected query like q1_1. dml. Both formats q1_1 or q1.1 are allowed. It will be automatically translated.
    - Currently, the following queries are available (q1_1, q1_2, q1_3, q2_1, q2_2, q2_3, q3_1, "q3_2,q3_3, q3_4, q4_1, q4_2, q4_3)
    - Default: `q2_1`
2. `-s`: (SCALE) The numerical scale factor like 0.01 or 1 etc.
    - Be careful: Please do not experiment with large scale factor over 0.2 in SystemDS. Its join operation is currently very slow.
    - Default: `0.1`
3. `-d`: (DB_SYSTEM) Name of the database system used.
    - `all`: executes queries in all three databases.
    - `systemds`: SystemDS executes DML scripts with basic output.
    - `systemds_stats`: SystemDS executes DML scripts with extended output (--stats).
    - `postgres`: PostgreSQL executes SQL queries.
    - `duckdb`: DuckDB executes SQL queries.
    - Default: `systemds`
4. `-g`: (GUI_DOCKER): Use GUI docker desktop. No arguments to pass. Set only the flag "-g".
5. `-h`: (HELP) Display the script explanation from ReadMe.md. No arguments to pass. Set only the flag "-h".
The command line could look like this:
```
$ ./run_script.sh -q [YOUR_QUERY_NAME] -s [YOUR_SCALE] -d [YOUR_DB_SYSTEM]
```
Examples
```
$ ./run_script.sh -q all -s 0.1 -d all
$ ./run_script.sh -q q4_3 -s 0.1 -d systemds
$ ./run_script.sh -q all -s 1 -d duckdb
$ ./run_script.sh -q q1.1 -s 1 -d postgres -g
```
