source("scripts/builtin/hdbscan.dml") as hdb

#   1 -> 1
#   2 -> 1
#   3 -> 2 -> 1
#   4 -> 4

n = 4
parent = matrix(0, rows=n, cols=1)
parent[1] = 1
parent[2] = 1
parent[3] = 2
parent[4] = 4

root1 = hdb::find(parent, 1)
root2 = hdb::find(parent, 2)
root3 = hdb::find(parent, 3)
root4 = hdb::find(parent, 4)

test_find = (root1 == 1) & (root2 == 1) & (root3 == 1) & (root4 == 4)

if(test_find) {
    print("Passed")
} else {
    print("Failed")
}

# ensure union() attaches lower-rank root under higher-rank root
# rank[1] < rank[2]  => parent[1] becomes 2

newId = 5  # arbitrary "new linkage node id" for this unit test

parentA = matrix(0, rows=n, cols=1)
parentA[1] = 1
parentA[2] = 2
parentA[3] = 3
parentA[4] = 4

rankA = matrix(0, rows=n, cols=1)
rankA[1] = 0
rankA[2] = 1
rankA[3] = 0
rankA[4] = 0

sizeA = matrix(1, rows=n, cols=1)

compToNodeA = matrix(0, rows=n, cols=1)
compToNodeA[1] = 1
compToNodeA[2] = 2
compToNodeA[3] = 3
compToNodeA[4] = 4

[newParentA, newRankA, newSizeA, newCompToNodeA, newRootA] = hdb::union(parentA, rankA, 1, 2, sizeA, compToNodeA, newId)
test_unionA = (as.scalar(newParentA[1]) == 2) & (as.scalar(newParentA[2]) == 2)

if(test_unionA) {
    print("Passed")
} else {
    print("Failed")
}

# ensure union() attaches lower-rank root under higher-rank root
# rank[1] > rank[2]  => parent[2] becomes 1

parentB = matrix(0, rows=n, cols=1)
parentB[1] = 1
parentB[2] = 2
parentB[3] = 3
parentB[4] = 4

rankB = matrix(0, rows=n, cols=1)
rankB[1] = 2
rankB[2] = 1
rankB[3] = 0
rankB[4] = 0

sizeB = matrix(1, rows=n, cols=1)

compToNodeB = matrix(0, rows=n, cols=1)
compToNodeB[1] = 1
compToNodeB[2] = 2
compToNodeB[3] = 3
compToNodeB[4] = 4

[newParentB, newRankB, newSizeB, newCompToNodeB, newRootB] = hdb::union(parentB, rankB, 1, 2, sizeB, compToNodeB, newId)
test_unionB = (as.scalar(newParentB[2]) == 1) & (as.scalar(newParentB[1]) == 1)

if(test_unionB) {
    print("Passed")
} else {
    print("Failed")
}

# check linkage
test_unionB = test_unionB & (newRootB == 1) & (as.scalar(newCompToNodeB[1]) == newId)

if(test_unionB) {
    print("Passed")
} else {
    print("Failed")
}


# ensure union() increments if height is same

parentC = matrix(0, rows=n, cols=1)
parentC[1] = 1
parentC[2] = 2
parentC[3] = 3
parentC[4] = 4

rankC = matrix(0, rows=n, cols=1)
rankC[1] = 0
rankC[2] = 0
rankC[3] = 0
rankC[4] = 0

sizeC = matrix(1, rows=n, cols=1)

compToNodeC = matrix(0, rows=n, cols=1)
compToNodeC[1] = 1
compToNodeC[2] = 2
compToNodeC[3] = 3
compToNodeC[4] = 4

[newParentC, newRankC, newSizeC, newCompToNodeC, newRootC] = hdb::union(parentC, rankC, 1, 2, sizeC, compToNodeC, newId)

test_unionC_parent = (as.scalar(newParentC[2]) == 1)
test_unionC_rank = (as.scalar(newRankC[1]) == 1)

test_unionC = test_unionC_parent & test_unionC_rank

test_unionC = test_unionC & (newRootC == 1) & (as.scalar(newCompToNodeC[1]) == newId)

if(test_unionC) {
    print("Passed")
} else {
    print("Failed")
}
